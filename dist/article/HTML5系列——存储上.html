<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTML5系列——存储(上) | 大猿猴的前端世界</title>
    <meta name="description" content="欢迎来到我的前端世界">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <meta name="theme-color" content="#1890ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.3f5ae191.css" as="style"><link rel="preload" href="/assets/js/app.01dd3535.js" as="script"><link rel="preload" href="/assets/js/2.bcf731be.js" as="script"><link rel="preload" href="/assets/js/15.a2afff9d.js" as="script"><link rel="prefetch" href="/assets/js/10.916c13ea.js"><link rel="prefetch" href="/assets/js/11.9998a03a.js"><link rel="prefetch" href="/assets/js/12.5c186018.js"><link rel="prefetch" href="/assets/js/13.6c85f7c4.js"><link rel="prefetch" href="/assets/js/14.6d847622.js"><link rel="prefetch" href="/assets/js/16.c661c3b8.js"><link rel="prefetch" href="/assets/js/17.643f19e2.js"><link rel="prefetch" href="/assets/js/18.327fb082.js"><link rel="prefetch" href="/assets/js/19.89c49ad7.js"><link rel="prefetch" href="/assets/js/20.ed8261e8.js"><link rel="prefetch" href="/assets/js/21.6757f849.js"><link rel="prefetch" href="/assets/js/22.d0fb5cb1.js"><link rel="prefetch" href="/assets/js/23.b2669008.js"><link rel="prefetch" href="/assets/js/24.eeb936d5.js"><link rel="prefetch" href="/assets/js/25.311f3c85.js"><link rel="prefetch" href="/assets/js/26.6650c292.js"><link rel="prefetch" href="/assets/js/3.c9d6ab87.js"><link rel="prefetch" href="/assets/js/4.0087b0ef.js"><link rel="prefetch" href="/assets/js/5.a97f2123.js"><link rel="prefetch" href="/assets/js/6.b11b1271.js"><link rel="prefetch" href="/assets/js/7.759f0a29.js"><link rel="prefetch" href="/assets/js/8.ab65738d.js"><link rel="prefetch" href="/assets/js/9.aa75556b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3f5ae191.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="大猿猴的前端世界" class="logo"> <span class="site-name can-hide">大猿猴的前端世界</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/article/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/more/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/article/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/more/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/" class="sidebar-link">HTML5系列——语义</a></li><li><a href="/article/HTML5系列——存储上.html" class="active sidebar-link">HTML5系列——存储(上)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#客户端存储简介" class="sidebar-link">客户端存储简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#存储方式" class="sidebar-link">存储方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#cookie" class="sidebar-link">cookie</a></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#web-存储" class="sidebar-link">Web 存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#localstorage" class="sidebar-link">localStorage</a></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#sessionstorage" class="sidebar-link">sessionStorage</a></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#cookie、localstorage、sessionstorage-在存储大小、作用范围、作用有效期的比较" class="sidebar-link">cookie、localStorage、sessionStorage 在存储大小、作用范围、作用有效期的比较</a></li></ul></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#web-数据库存储" class="sidebar-link">Web 数据库存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#indexeddb" class="sidebar-link">IndexedDB</a></li></ul></li><li class="sidebar-sub-header"><a href="/article/HTML5系列——存储上.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/article/HTML5系列——存储下.html" class="sidebar-link">HTML5系列——存储(下)</a></li><li><a href="/article/HTML5系列——video实现简易版弹幕视频.html" class="sidebar-link">HTML5系列——video实现简易版弹幕视频</a></li><li><a href="/article/HTML5系列——Canvas应用.html" class="sidebar-link">HTML5系列——Canvas应用</a></li><li><a href="/article/CSS3系列——CSS3动画实现3D倒计时.html" class="sidebar-link">CSS3系列——CSS3动画实现3D倒计时</a></li><li><a href="/article/ES系列——Promise基础.html" class="sidebar-link">ES系列——Promise基础</a></li><li><a href="/article/ES系列——Generator函数与Async函数.html" class="sidebar-link">ES系列——Generator函数与Async函数</a></li><li><a href="/article/ES系列——模块化规范与ES6模块.html" class="sidebar-link">ES系列——模块化规范与ES6模块</a></li><li><a href="/article/Web技术系列——BOM基础.html" class="sidebar-link">Web技术系列——BOM基础</a></li><li><a href="/article/工具篇——markdown入门.html" class="sidebar-link">工具篇——markdown入门</a></li><li><a href="/article/工具篇——Hexo基础.html" class="sidebar-link">工具篇——Hexo基础</a></li><li><a href="/article/工具篇——使用Hexo在Github快速建站.html" class="sidebar-link">工具篇——使用Hexo在Github快速建站</a></li><li><a href="/article/工具篇——VuePress建站.html" class="sidebar-link">工具篇——VuePress建站</a></li><li><a href="/article/工具篇——VSCode如何一键生成模板.html" class="sidebar-link">工具篇——VSCode如何一键生成模板</a></li><li><a href="/article/工具篇——Postman如何作并发请求.html" class="sidebar-link">工具篇——Postman如何作并发请求</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>这一篇让我们踏上客户端存储与离线技术之旅，篇幅比较长，分为上篇和下篇。现在正式开始！</p> <h2 id="客户端存储简介"><a href="#客户端存储简介" class="header-anchor">#</a> 客户端存储简介</h2> <h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <ul><li><p>客户端存储遵循浏览器的同源策略，即同一站点的数据是共享的，而非同一站点不可共享。也不支持跨浏览器，同一站点在不同浏览器打开，数据无法共享。</p></li> <li><p>客户端存储的数据都是未加密的形式，从安全角度而言，不应存储敏感信息。</p></li></ul> <h3 id="存储方式"><a href="#存储方式" class="header-anchor">#</a> 存储方式</h3> <ul><li><p>cookie</p> <p>早期的客户端存储机制。</p></li> <li><p>Web 存储</p> <p>我们熟知的 localStorage 和 sessionStorage。</p></li> <li><p>Web 数据库存储</p> <p>介绍索引数据库 Indexed Database，其 API 大多是异步的，采用事件监听处理机制。</p></li> <li><p>文件存储</p> <p>一个私有的本地文件系统，可利用其 API 进行文件的读写。</p></li> <li><p><s>离线 Web 应用（已过时）</s></p> <p><s>应用程序存储，存储着 Web 页面以及相关资源如 CSS、脚本、图像等。</s></p></li></ul> <blockquote><p>除以上存储方式，还有另两种只简单提及下，不具体展开介绍。IE5 版本后，微软引入 IE 专有的客户端存储机制 userData，如果需兼容 IE8 及之前，可将其作为 Web 存储替代方案，这是第一种。另一种，起初各大厂商都有在浏览器内集成了客户端数据库，但 Web SQL API 标准化工作最终失败收尾，目前仅有索引数据库 API 还在标准化中。这两种技术在技术角逐中已被淘汰，了解即可。</p></blockquote> <h2 id="cookie"><a href="#cookie" class="header-anchor">#</a> cookie</h2> <ul><li><p>机制：一个在浏览器和服务器之间传送文本的内置机制。每当用户访问某个域时，cookie 都会被自动来回传送，两端均可对其进行读写。</p></li> <li><p>用途：存储会话标识，识别身份；数据缓存。</p></li> <li><p>缺点：有数目和大小限制，浏览器保存的 cookie 不超过 300 个，为每个服务器保存的 cookie 不超过 20 个，每个 cookie 的大小不超过 4KB。消耗网络带宽。API 操作繁琐。</p></li> <li><p>属性</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 名称</span>
name
<span class="token comment">// 值，不允许包含分号、逗号和空白符，存储前必须编码。</span>
value
<span class="token comment">// 有效期：单位为秒。设置有效期的cookie会存储在一个文件中，过期自动删除</span>
max<span class="token operator">-</span>age
<span class="token comment">// 路径：控制cookie作用域因素之一。cookie默认只对创建它的页面及与该页面同级目录或其子目录的其他页面可见。若取值为“/”，则表示整个站点都是可以访问的，作用域基本同localStorage。</span>
path
<span class="token comment">// 域：控制cookie作用域因素之一。默认值是当前服务器主机名。若希望子域间共享cookie，可以设置为“.一级域名.顶层域名”，比如blog.mudong.xyz和docs.mudong.xyz，设置domain值为&quot;.mudong.xyz&quot;，上面两个域名就共享数据了。</span>
domain
<span class="token comment">// 是否安全：表明cookie的值以何种形式通过网络传递。默认是以不安全的形式(http)传递，若使用了该属性则表明cookie只能通过https或其他安全协议传递。</span>
secure
</code></pre></div></li> <li><p>操作 cookie</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 添加或修改cookie</span>
<span class="token keyword">function</span> <span class="token function">addCookie</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>value<span class="token punctuation">,</span>maxAge<span class="token punctuation">,</span>path<span class="token punctuation">,</span>domain<span class="token punctuation">,</span>secure</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cookie <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; max-age=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxAge<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cookie <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; path=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cookie <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; domain=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>secure<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cookie <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; secure</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除cookie</span>
<span class="token keyword">function</span> <span class="token function">deleteCookie</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=; max-age=0</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询cookie</span>
<span class="token keyword">function</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> cookie <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> cookie<span class="token punctuation">)</span><span class="token punctuation">{</span>
    item <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="web-存储"><a href="#web-存储" class="header-anchor">#</a> Web 存储</h2> <h3 id="localstorage"><a href="#localstorage" class="header-anchor">#</a> localStorage</h3> <ul><li><p>键和值都是字符串类型，所以若要存储对象，需要进一步封装处理如下。</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">setStorage</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>当存储的是非字符串的基本数据类型时，获取返回的是字符串形式的值；当存储的是非对象字面量的引用数据类型时，获取返回的是值的 toString 形式。</p></blockquote></li> <li><p>存储 API</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取键值对的长度</span>
length
<span class="token comment">// 设置键值对</span>
<span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
<span class="token comment">// 获取指定键的值</span>
<span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token comment">// 删除指定键</span>
<span class="token function">removeItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token comment">// 清空所有键</span>
<span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 根据存储的索引获取指定的键名</span>
<span class="token function">key</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>存储事件</p></li></ul> <ol><li><p>介绍存储事件前，先说如何对事件绑定与事件解绑的兼容处理，直接贴代码。</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bindEvent</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>callback<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    eventName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">unbindEvent</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>removeEventListener<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    eventName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>detachEvent<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">detachEvent</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>使用 addEventListener 或 attachEvent 多次绑定同一元素的同一事件，最终的事件处理并不是只执行最后一次绑定事件处理函数，而是所有绑定的事件处理函数会被依次执行，但通过花括号形式绑定事件只执行最后一次绑定事件处理函数。</p></blockquote></li> <li><p>认识存储事件</p> <p>触发对象：对操作的存储数据可见的其他窗口对象，不包括对数据操作的当前窗口对象。</p> <p>触发条件：存储数据的值发生变化，注意重新赋于存储项相同的旧值或删除不存在的存储项，不会引起变化。</p> <p>机制：采用广播通知其他同源窗口对象。下面是存储事件应用示例，实现在一个窗口控制另一个窗口的动画，更好理解广播机制。</p> <div class="language-Html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>存储事件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">#circle</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> yellow<span class="token punctuation">,</span> red<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token selector">.circle-anim</span> <span class="token punctuation">{</span>
        <span class="token property">animation</span><span class="token punctuation">:</span> anim_rotate 2s infinite ease-in-out<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token atrule"><span class="token rule">@keyframes</span> anim_rotate</span> <span class="token punctuation">{</span>
        <span class="token selector">0%</span> <span class="token punctuation">{</span>
          <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">100%</span> <span class="token punctuation">{</span>
          <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>circle<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>circle-anim<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-stop-anim<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>停止动画<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn-start-anim<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>继续动画<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">let</span> circleEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#circle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> stopBtnEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#btn-stop-anim'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> startBtnEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#btn-start-anim'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      stopBtnEle<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      startBtnEle<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'storage'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>
          <span class="token comment">// 键名</span>
          key<span class="token punctuation">,</span>
          <span class="token comment">// 旧值，默认为null</span>
          newValue<span class="token punctuation">,</span>
          <span class="token comment">// 新值</span>
          oldValue<span class="token punctuation">,</span>
          <span class="token comment">// 存储对象</span>
          storageArea<span class="token punctuation">,</span>
          <span class="token comment">// 数据变化的源地址</span>
          url
        <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'state'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> <span class="token string">'stop'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          circleEle<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'circle-anim'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> <span class="token string">'start'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          circleEle<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'circle-anim'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ol> <h3 id="sessionstorage"><a href="#sessionstorage" class="header-anchor">#</a> sessionStorage</h3> <ul><li><p>sessionStorage 同样支持上述 localStorage 的特性和 API</p></li> <li><p>在单页应用中，sessionStorage 与 localStorage 作用范围并无差异，建议使用 sessionStorage，因为可以利用其有效期，在网页一关闭便会删除本地数据，避免数据不被使用时被泄露。</p></li></ul> <h3 id="cookie、localstorage、sessionstorage-在存储大小、作用范围、作用有效期的比较"><a href="#cookie、localstorage、sessionstorage-在存储大小、作用范围、作用有效期的比较" class="header-anchor">#</a> cookie、localStorage、sessionStorage 在存储大小、作用范围、作用有效期的比较</h3> <table><thead><tr><th></th> <th>localStorage</th> <th>sessionStorage</th> <th>cookie</th></tr></thead> <tbody><tr><td>存储大小</td> <td>不超过 5MB</td> <td>不超过 5MB</td> <td>不超过 4KB(即名字和值的总量不超过 4KB)</td></tr> <tr><td>作用范围</td> <td>同源</td> <td>同源且同顶级窗口</td> <td>同源</td></tr> <tr><td>作用有效期</td> <td>永久有效</td> <td>在顶级窗口或当前标签页关闭前有效</td> <td>在到达过期时间前有效，即使期间浏览器关闭</td></tr></tbody></table> <h2 id="web-数据库存储"><a href="#web-数据库存储" class="header-anchor">#</a> Web 数据库存储</h2> <h3 id="indexeddb"><a href="#indexeddb" class="header-anchor">#</a> IndexedDB</h3> <ul><li><p>基本认识</p> <p>一个面向对象的数据库，因为它实质上是一个命名对象存储区的集合，存储的是对象。</p> <p>每个对象都有一个唯一的key，会自动生成，通常需要为该key显示指定一条键路径，告知数据库如何从一个对象中抽取出该对象的键。</p> <p>支持索引，能为存储对象定义次键，可以不唯一，即多个对象能匹配一个键值，因此被称为IndexedDB。</p> <p>保证原子性，支持事务，即数据库操作都是在一个事务中，要么都成功，要么都失败。事务无需手动提交，当事务完成，浏览器回到事件循环，事务中所有挂起操作完成后，会自动提交。</p></li> <li><p>特点</p> <p>仅同源内可访问</p> <p>数据库的数目无限制</p> <p>同源内的数据库名字唯一</p></li> <li><p>API一览</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// IDBOpenDBRequest：表示访问打开或删除数据库的请求结果</span>
<span class="token comment">// 属性</span>
error
readyState
result
source
transaction
<span class="token comment">// 事件</span>
onblocked
onerror
onsuccess
onupgradeneeded
</code></pre></div><div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// IDBDatabase：表示数据库</span>
<span class="token comment">// 属性</span>
name
objectStoreNames
version
<span class="token comment">// 事件</span>
onabort
onclose
onerror
onversionchange
<span class="token comment">//方法</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">deleteObjectStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// IDBObjectStore：表示对象存储，可进行增删改查操作</span>
<span class="token comment">// 属性</span>
indexNames
keyPath
name
transaction
autoIncrement
<span class="token comment">// 方法</span>
<span class="token function">add</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token keyword">delete</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> 
<span class="token function">put</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token keyword">get</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> 
<span class="token function">clear</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token function">count</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token function">createIndex</span>  <span class="token punctuation">(</span>name<span class="token punctuation">,</span>keyPath<span class="token punctuation">[</span><span class="token punctuation">,</span> unique<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token function">deleteIndex</span> <span class="token punctuation">(</span>indexName<span class="token punctuation">)</span> 
<span class="token function">index</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
<span class="token function">openCursor</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>range<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">,</span> direction<span class="token punctuation">]</span><span class="token punctuation">)</span> 
</code></pre></div><div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// IDBTransaction：表示一个事务</span>
<span class="token comment">// 属性</span>
db
error
mode
objectStoreNames
<span class="token comment">// 事件</span>
onabort
oncomplete
onerror
<span class="token comment">// 方法</span>
<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>小小示例</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 1.创建或打开数据库。open方法指定dbName和可选的dbVersion</span>
<span class="token keyword">let</span> request <span class="token operator">=</span> window<span class="token punctuation">.</span>indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'create db success...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initDB</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;access db success...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> db <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>version <span class="token operator">!==</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">operateDB</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queryDB</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'create or open db fail...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

request<span class="token punctuation">.</span><span class="token function-variable function">onblocked</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;db is blocked...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">initDB</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token comment">// 2.建立对象存储和索引</span>
  <span class="token comment">// createObjectStore指定存储名称和字段约束选项</span>
  <span class="token keyword">let</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'student'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>keyPath<span class="token operator">:</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>autoIncrement<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// createIndex指定索引名称、作为索引的字段名和可选的字段约束选项</span>
  store<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token string">&quot;classes&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'db close...'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  db<span class="token punctuation">.</span><span class="token function-variable function">onabort</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'db abort...'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  db<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'db error...'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  db<span class="token punctuation">.</span><span class="token function-variable function">onversionchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'db version change...'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">operateDB</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token comment">// 3.获取事务对象。transaction指定存储名称和model，可取值为readwrite和readonly</span>
  <span class="token keyword">let</span> transaction <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'student'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;readwrite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4.获取对象存储</span>
  <span class="token keyword">let</span> store <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;student&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 5.操作数据</span>
  store<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">class</span><span class="token operator">:</span><span class="token string">'one'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span><span class="token string">'xiaoming'</span><span class="token punctuation">,</span>
    score<span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span>
    subject<span class="token operator">:</span><span class="token string">'math'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">class</span><span class="token operator">:</span><span class="token string">'one'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span><span class="token string">'xiaoming'</span><span class="token punctuation">,</span>
    score<span class="token operator">:</span><span class="token number">90</span><span class="token punctuation">,</span>
    subject<span class="token operator">:</span><span class="token string">'chinese'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">class</span><span class="token operator">:</span><span class="token string">'one'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span><span class="token string">'xiaohong'</span><span class="token punctuation">,</span>
    score<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">,</span>
    subject<span class="token operator">:</span><span class="token string">'chinese'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  transaction<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'transaction operation...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  transaction<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'transaction error...'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">queryDB</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token keyword">let</span> transaction <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'student'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;readwrite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> store <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;student&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> idx <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">'classes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 查询符合某一键值的一个对象</span>
  <span class="token keyword">let</span> req <span class="token operator">=</span> idx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">I'm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>result<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in class </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>result<span class="token punctuation">.</span>class<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>result<span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>result<span class="token punctuation">.</span>subject<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 查询符合某一键值的所有对象</span>
  idx<span class="token punctuation">.</span><span class="token function">openCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> cursor <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// continue亦可传入IDBKeyRange.upperBound、lowerBound、bound或only进行限制查询</span>
      cursor<span class="token punctuation">.</span><span class="token function">continue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cursor query end...'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><p>JavaScript权威指南（第6版）</p></li> <li><p>https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API</p></li></ul> <blockquote><p>至此，文章已经介绍了cookie、Web Storage和Web 数据库三种存储技术，接下来的文件存储和离线应用会在下篇进行介绍。</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/article/" class="prev router-link-active">
        HTML5系列——语义
      </a></span> <span class="next"><a href="/article/HTML5系列——存储下.html">
        HTML5系列——存储(下)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.01dd3535.js" defer></script><script src="/assets/js/2.bcf731be.js" defer></script><script src="/assets/js/15.a2afff9d.js" defer></script>
  </body>
</html>
