本篇先交代浏览器兼容性的定义、原因、处理的必要性，然后介绍浏览器兼容性测试的步骤，最后介绍如何搭建自动化测试环境

## 浏览器兼容性问题与处理
指跨不同浏览器、设备、浏览偏好时出现的表现差异问题。可能原因是浏览器有缺陷或者实现功能的方式不同，或是对一些技术特点的支持力度与其他浏览器不同，又或是一些设备可能会制定一些限制来防止网站运行缓慢或显示效果糟糕等等。

为此需要确保web应用能在可接受数量(不需要100%)的浏览器上正常使用(允许不同浏览器体验不同，但是都要能提供可接受的用户体验)

点击查看当前[浏览器市场份额](https://gs.statcounter.com/)

## 跨浏览器测试步骤
- 明确要兼容的浏览器范围`browserlist`

  [根据设定的范围检查覆盖率](https://browsersl.ist/)

- 浏览器同步测试`browsersync`

  [工具下载](https://browsersync.io/docs/command-line)

  可考虑自动化测试辅之，如基于CDP(Chrome DevTools Protocol)的Puppeteer(只适于基于Chromium内核的浏览器)、基于WebDriver的Selenium(适于所有浏览器)

  商业测试服务
  - Sauce Labs
  - BrowserStack
  - [lambda test](https://www.lambdatest.com/cross-browser-testing)

- 发现有兼容问题的属性`caniuse`
  
  [查询某特性整体兼容情况](https://caniuse.com/)

  [检查某一浏览器兼容情况](https://tests.caniuse.com)

- 特征检测`modernizr`或hack兼容处理`browserhacks`

  特征检测指检查浏览器是否支持一个特定块中的代码，以运行不同的代码，保证所有的浏览器都可以正常工作，而不是在某些浏览器中崩溃或出错

  modernizr提供[完整的特征检测方法](https://github.com/Modernizr/Modernizr)，也能通过访问[此链接](https://modernizr.github.io/Modernizr/test/integration.html)检查访问的浏览器兼容情况

  browserhacks网站提供[常见的hack处理](http://browserhacks.com/)

> CSS特征检测与兼容前缀
  ```javascript
  // CSS特性可通过以下方式检测
  const supportsCSS = window.CSS && window.CSS.supports;
  if (supportsCSS) {
    supportsCSS('display', 'flex');
  }
  ```
>
> CSS兼容前缀：针对同一样式属性，为不同浏览器添加不同前缀，具体如下，

  | 前缀 | 浏览器内核 | 浏览器 |
  |--------|-----------|--------|
  | -webkit- | WebKit/Blink | Safari、Chrome、Edge、Android、IOS |
  | -moz- | Gecko | Firefox |
  | -ms- | Trident/EdgeHTML | IE/旧Edge |
  | -o- | Presto | 旧Opera |


## 搭建自动化测试环境
### 自动化测试从安装驱动到用例开发
1.下载驱动并解压，添加到环境变量

驱动地址：
- http://chromedriver.storage.googleapis.com/index.html
- https://github.com/mozilla/geckodriver/releases/

```bash
# 打开bash_profile，修改环境变量
vi .bash_profile
```

```bash
# 添加到环境变量
export PATH=$PATH:驱动路径
```

```bash
# 重启检验
source .bash_profile
echo $PATH
```

2.创建项目，安装依赖，编写代码并运行
```bash
npm install selenium-webdriver
```

```javascript
// 参自https://www.selenium.dev/documentation/en/
const {
  Builder, 
  By, 
  Key, 
  until
} = require('selenium-webdriver');

(async function example() {
	const driver = await new Builder().forBrowser('firefox').build();
	try {
    // Navigate to Url
    await driver.get('https://www.google.com');

    // Enter text "cheese" and perform keyboard action "Enter"
    await driver.findElement(By.name('q')).sendKeys('cheese', Key.ENTER);

    let firstResult = await driver.wait(until.elementLocated(By.css('h3>div')), 10000);

    console.log(await firstResult.getAttribute('textContent'));
	}
	finally{
		driver.quit();
	}
})();
```

```js
// 一次测试多个浏览器
const {
  Builder, 
  By, 
  Key, 
  until
} = require('selenium-webdriver'),

const driver_fx = new Builder().forBrowser('firefox').build();
const driver_chr = new Builder().forBrowser('chrome').build();

searchTest(driver_fx);
searchTest(driver_chr);

function searchTest(driver) {
  driver.get('http://www.google.com');
  driver.findElement(By.name('q')).sendKeys('webdriver');

  driver.sleep(1000).then(function() {
    driver.findElement(By.name('q')).sendKeys(webdriver.Key.TAB);
  });

  driver.findElement(By.name('btnK')).click();

  driver.sleep(2000).then(function() {
    driver.getTitle().then(function(title) {
      if(title === 'webdriver - Google Search') {
        console.log('Test passed');
      } else {
        console.log('Test failed');
      }
    });
  });

  driver.quit();
}
```

### 自动化测试用例最佳实践
- 使用好的定位策略
- 写原子测试: 一个测试只测一件事
- 写独立测试：每个测试只需自己执行，不依赖其它测试
- 支持生成测试报告，集成Mocha + Chai + Karma
- 部署自动化测试服务器环境
	
	- 下载、安装JDK 
	
  - 下载[selenium-server-standalone](http://selenium-release.storage.googleapis.com/index.html)，并启动selenium服务器 
  ```bash
  # 启动selenium服务器
	java -jar selenium-server-standalone-3.0.0.jar
	```

  - 访问http://serverAddress:4444/wd/hub，检查是否启动成功

  - 接入上面WebDriver接口，供远程测试脚本连接，控制浏览器
	
- 引入Travis CI，使测试工作更简单
